---
phase: 01-ui-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/market-scraper.js
  - src/components/ui-components.js
autonomous: false
requirements:
  - FILT-01
  - DRAG-01

must_haves:
  truths:
    - User changes percentage input, clicks Apply, bot uses that value immediately
    - Invalid input shows error notification and does not apply any value
    - User can drag overlay from any non-interactive surface area
    - Clicking buttons or inputs inside overlay does not trigger drag
    - Overlay stays at new position after dragging
  artifacts:
    - path: src/market-scraper.js
      provides: Fixed Apply button handler with input validation and dual-system update
      contains: itemFilter.updateBaseFilters
    - path: src/components/ui-components.js
      provides: Full-surface drag with interactive element exclusion
      contains: DRAG_EXCLUDED_TAGS
  key_links:
    - from: src/market-scraper.js Apply handler
      to: this.itemFilter.updateBaseFilters
      via: direct method call after validation
      pattern: "itemFilter\\.updateBaseFilters"
    - from: src/components/ui-components.js dragStart
      to: overlay element mousedown listener
      via: DOMUtils.addEventListeners(overlay)
      pattern: "addEventListeners.*overlay"
---

<objective>
Fix two broken UI interactions in the existing userscript overlay: (1) wire the Alert Threshold input's Apply button to the ItemFilter engine so the user's value is actually used, and (2) allow the overlay to be dragged from any point on its surface instead of only the title handle.

Purpose: Both bugs make the existing UI controls non-functional — the threshold setting is silently ignored, and dragging from content areas does nothing. This phase restores the expected behavior of controls that already exist.
Output: Modified src/market-scraper.js (Apply handler) and src/components/ui-components.js (drag handler). No new files.
</objective>

<execution_context>
@C:/Users/oresp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/oresp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ui-fixes/01-RESEARCH.md
@src/market-scraper.js
@src/components/ui-components.js
@src/filters/item-filter.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix FILT-01 — Wire Apply button to ItemFilter with input validation</name>
  <files>src/market-scraper.js</files>
  <action>
Replace the existing Apply button handler in `createSniperControls()` (lines 296-311 of src/market-scraper.js) with a validated handler that updates both ItemFilter and MarketMonitor.

**Step 1 — Update the threshold input `min` attribute.**
The input at lines 280-289 has `min: '0.1'`. Change it to `min: '0'` to honor the locked decision that 0% is a valid threshold.

**Step 2 — Replace the `applyBtn` handler (lines 296-311).**
Remove the entire existing `const applyBtn = UIComponents.createButton(...)` block and replace it with:

```js
const applyBtn = UIComponents.createButton('Apply', 'primary', 'sm', () => {
    const rawValue = thresholdInput.value.trim();

    // Validation: empty field
    if (rawValue === '') {
        UIComponents.showNotification('Threshold cannot be empty', 'error');
        return;
    }

    // Validation: use Number() (stricter than parseFloat — rejects '5abc')
    const parsed = Number(rawValue);
    if (isNaN(parsed)) {
        UIComponents.showNotification('Invalid threshold: must be a number', 'error');
        return;
    }

    // Validation: range 0–100
    if (parsed < 0 || parsed > 100) {
        UIComponents.showNotification('Threshold must be between 0 and 100', 'error');
        return;
    }

    // Apply to ItemFilter — maxPercentageChange is in % (e.g., 5.1, not 0.051)
    this.itemFilter.updateBaseFilters({ maxPercentageChange: parsed });

    // Keep MarketMonitor in sync — its priceThreshold is a fraction (e.g., 0.051)
    const marketMonitor = this.automationManager.getAutomation('market-monitor');
    if (marketMonitor && marketMonitor.updatePriceThreshold) {
        marketMonitor.updatePriceThreshold(parsed / 100);
    }

    // Visual feedback
    UIComponents.showNotification(`Threshold set to ${parsed}%`, 'success');
    const originalText = applyBtn.textContent;
    applyBtn.textContent = '✓ Applied';
    applyBtn.style.backgroundColor = Theme.colors.success;
    setTimeout(() => {
        applyBtn.textContent = originalText;
        applyBtn.style.backgroundColor = '';
    }, 1500);
});
```

**Step 3 — Initialize input from ItemFilter on overlay creation.**
At the point where `thresholdInput` is created (line 280), add an initializer immediately after the element is created that reads the current active filter value so the displayed value matches what the filter is actually using:

```js
// Initialize input from live ItemFilter value (source of truth)
thresholdInput.value = String(this.itemFilter.baseFilters.maxPercentageChange ?? 5.1);
```

**Key constraints:**
- Do NOT silently reset the input on error — show the error and leave the input value as-is so the user can correct it.
- Do NOT call `marketMonitor.updatePriceThreshold` without the null guard — it may be null if the automation is not running.
- Units: pass `parsed` (e.g., 5.1) to `updateBaseFilters`, pass `parsed / 100` (e.g., 0.051) to `updatePriceThreshold`. These are different units.
  </action>
  <verify>
1. Open the bundled userscript in a browser (run `npm run build` first, then load `dist/index.bundle.js` in Tampermonkey or similar).
2. Open the overlay (Ctrl+Shift+S).
3. Navigate to the Market Sniper tab.
4. Verify the Alert Threshold input shows the ItemFilter's current value (5.1 by default), not the hardcoded "5.0".
5. Enter an invalid value (e.g., blank field) and click Apply — verify an error notification appears and no threshold change occurs.
6. Enter "abc" and click Apply — verify error notification.
7. Enter "-5" and click Apply — verify "between 0 and 100" error notification.
8. Enter "150" and click Apply — verify "between 0 and 100" error notification.
9. Enter "8.5" and click Apply — verify "Threshold set to 8.5%" success notification appears and the Apply button briefly shows "✓ Applied".
10. Grep: `grep -n "itemFilter.updateBaseFilters" src/market-scraper.js` — must return a line in the Apply handler.
  </verify>
  <done>
Clicking Apply with a valid percentage (0–100, decimals allowed) immediately updates ItemFilter.baseFilters.maxPercentageChange and MarketMonitor.settings.priceThreshold. Clicking Apply with an empty, non-numeric, or out-of-range value shows an error notification and does not update either system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix DRAG-01 — Full-surface overlay drag with interactive element exclusion</name>
  <files>src/components/ui-components.js</files>
  <action>
Modify `createDragHandle()` in `src/components/ui-components.js` (the function starting around line 90) to move the `mousedown` listener from `dragHandle` to `overlay` and add an exclusion check for interactive elements.

**Step 1 — Add the exclusion set before `dragStart`.**
Immediately before the `dragStart` function definition (currently line 102), add:

```js
const DRAG_EXCLUDED_TAGS = new Set(['INPUT', 'TEXTAREA', 'SELECT', 'BUTTON', 'A']);
```

**Step 2 — Rewrite `dragStart` to remove the `e.target === dragHandle` guard and add exclusion logic.**
Replace:
```js
const dragStart = (e) => {
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;
    if (e.target === dragHandle) {
        isDragging = true;
    }
};
```
With:
```js
const dragStart = (e) => {
    // Do not start drag on interactive elements — they handle their own clicks
    if (DRAG_EXCLUDED_TAGS.has(e.target.tagName)) return;
    if (e.target.closest('button, input, textarea, select, a')) return;

    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;
    isDragging = true;
};
```

**Step 3 — Move the `mousedown` listener from `dragHandle` to `overlay`.**
At line 132, change:
```js
DOMUtils.addEventListeners(dragHandle, { mousedown: dragStart });
```
To:
```js
DOMUtils.addEventListeners(overlay, { mousedown: dragStart });
```

Do NOT add a second listener — replace the existing one. The old listener on `dragHandle` must be removed entirely (replaced by this new one on `overlay`). If both remain, drag position will track double-speed.

**No other changes needed:**
- The `document` listeners for `mousemove` and `mouseup` (lines 133-136) stay exactly as-is.
- The `onPositionSave` callback listener on `overlay` (lines 138-142) stays exactly as-is.
- The `dragHandle` element itself can remain for visual styling (the grab cursor on the header is fine).
- The `dragHandle.xOffset` and `dragHandle.yOffset` property assignments at lines 99-100 and 126-127 can be left in place — they are harmless, though they are no longer the canonical xOffset/yOffset values (the closure variables are).
  </action>
  <verify>
1. Build: `npm run build`.
2. Load the overlay in a browser.
3. Try dragging from the title bar area — overlay must move. (Baseline still works.)
4. Try dragging from a content label (e.g., the "Alert Threshold:" text) — overlay must move.
5. Try dragging from empty space inside the overlay — overlay must move.
6. Click a button inside the overlay (e.g., "Start Sniper") — overlay must NOT start dragging.
7. Click inside a text input — overlay must NOT start dragging.
8. After dragging to a new position, release and click elsewhere — overlay must stay at the new position (position persistence still works).
9. Grep: `grep -n "addEventListeners(overlay" src/components/ui-components.js` — must return the dragStart line (in addition to the existing onPositionSave line).
10. Grep: `grep -n "addEventListeners(dragHandle" src/components/ui-components.js` — must return 0 results (old listener removed).
  </verify>
  <done>
The overlay can be clicked and dragged from any point on its surface except interactive elements (buttons, inputs, selects, textareas, links). Dragging moves the overlay smoothly. Position persists after dragging. Interactive elements inside the overlay still respond to clicks normally.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify both UI fixes work end-to-end in the browser</name>
  <action>Human verification of automated changes from Tasks 1 and 2. Load the built userscript and test both fixes manually in the browser.</action>
  <what-built>
    Task 1: Apply button now validates input (empty/non-numeric/out-of-range = error notification) and on valid input updates both ItemFilter.baseFilters.maxPercentageChange and MarketMonitor.settings.priceThreshold.
    Task 2: Overlay drag now works from the entire surface, with interactive elements (buttons, inputs) excluded from drag initiation.
  </what-built>
  <how-to-verify>
    1. Run `npm run build` to produce `dist/index.bundle.js`.
    2. Load the userscript in Tampermonkey on the target page and open the overlay (Ctrl+Shift+S).
    3. **Filter test:** On the Market Sniper tab, clear the Alert Threshold input and click Apply -- confirm an error notification appears. Type "200" and click Apply -- confirm error. Type "8.5" and click Apply -- confirm success toast and "Applied" button feedback.
    4. **Drag test:** Grab and drag the overlay from the body content area (not just the title bar) -- confirm the overlay moves with the cursor. Click a button inside the overlay -- confirm no drag initiates.
    5. **Position persistence:** Drag overlay to a corner, release, then click anywhere -- confirm overlay stays put.
  </how-to-verify>
  <verify>User confirms both fixes work as described in how-to-verify steps above.</verify>
  <done>Both FILT-01 and DRAG-01 verified working in the browser by the user.</done>
  <resume-signal>Type "approved" if both fixes work correctly, or describe which test failed and what happened.</resume-signal>
</task>

</tasks>

<verification>
- `grep -n "itemFilter.updateBaseFilters" src/market-scraper.js` returns a line inside the Apply handler
- `grep -n "addEventListeners(overlay" src/components/ui-components.js` returns the mousedown line
- `grep -n "addEventListeners(dragHandle" src/components/ui-components.js` returns no results (old listener gone)
- `grep -n "e.target === dragHandle" src/components/ui-components.js` returns no results (bug removed)
- `npm run build` exits with code 0
</verification>

<success_criteria>
1. User changes the Alert Threshold input to any value in 0–100 (decimals allowed), clicks Apply, and the bot's ItemFilter immediately uses that value — the hardcoded 5.1% default is never applied again after a valid Apply.
2. Entering an empty, non-numeric, negative, or >100 value and clicking Apply shows a notification error and does not change the active threshold.
3. User can click and drag the overlay from any non-interactive location on its surface. Dragging works from labels, content areas, and empty space. Position is preserved after dragging.
4. Interactive elements (buttons, inputs, selects, textareas, links) inside the overlay still receive their own click/focus events normally and do not trigger drag.
</success_criteria>

<output>
After completion, create `.planning/phases/01-ui-fixes/01-01-SUMMARY.md` with:
- What was changed (files + specific lines modified)
- Patterns used (validation approach, exclusion set, dual-system sync)
- Any deviations from the plan and why
- Confirmation that both FILT-01 and DRAG-01 requirements are satisfied
</output>
